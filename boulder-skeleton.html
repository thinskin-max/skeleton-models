<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Boulder Skeleton â€” Pro (Adaptive Layout)</title>
<style>
  :root{
    --bg:#0b0c10; --card:#111318; --line:#1f232b; --ink:#e6e6e6; --muted:#9fb0c4;
    --side-w:320px;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  header{padding:12px 16px;border-bottom:1px solid var(--line);display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .badge{font-size:12px;opacity:.9}
  .kpi{display:flex;gap:12px;align-items:center;font-size:12px;opacity:.9}
  progress{height:10px}

  /* å¸ƒå±€ï¼šä¸»ä½œæ¥­å€ + å³å´çª„æ¬„ */
  .layout{
    display:grid; grid-template-columns: 1fr var(--side-w); gap:16px; padding:16px;
  }
  section, aside{background:var(--card); border:1px solid var(--line); border-radius:12px; overflow:hidden}
  .pane-head{padding:10px 14px;border-bottom:1px solid var(--line);font-weight:600;display:flex;justify-content:space-between;align-items:center}
  .pane-body{padding:12px}
  .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  button,input[type=file],select{background:#1a1d24;border:1px solid #2a2f3a;color:var(--ink);border-radius:10px;padding:8px 12px;cursor:pointer}
  button:hover{background:#222632}
  video,canvas{max-width:100%;border-radius:10px;border:1px solid var(--line);background:#000;display:block}

  /* å³å´æ›´å°ã€æ›´ç¯€çœç©ºé–“ */
  aside .pane-body{padding:10px}
  .log{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:11px;line-height:1.35;white-space:pre-wrap;background:#0e1015;border:1px solid var(--line);border-radius:8px;padding:8px;max-height:200px;overflow:auto;color:var(--muted)}
  .ai{white-space:pre-wrap;background:#0e1015;border:1px solid var(--line);border-radius:8px;padding:8px;min-height:72px;font-size:12px}
  .ok{color:#8be48b}.warn{color:#ffd37a}.err{color:#ff8b8b}

  /* åª’é«”å€ï¼šä¾ã€Œå½±ç‰‡æ–¹å‘ã€è‡ªé©æ‡‰ */
  .media-grid{display:grid;gap:10px}
  /* æ©«å‘å½±ç‰‡ï¼šoverlay åœ¨åŸå§‹å½±ç‰‡ä¸‹æ–¹ï¼ˆä¸Šä¸‹æ’åˆ—ï¼‰ */
  .landscape .media-grid{
    grid-template-columns: 1fr;
    grid-template-areas: "orig" "overlay";
  }
  /* ç›´å‘å½±ç‰‡ï¼šåŸå§‹èˆ‡overlay å·¦å³ä¸¦æ’ */
  .portrait .media-grid{
    grid-template-columns: 1fr 1fr;
    grid-template-areas: "orig overlay";
    align-items:start;
  }
  .origWrap{grid-area:orig}
  .overlayWrap{grid-area:overlay}

  /* å°è¢å¹•ï¼šå³å´æ¬„æ‰åˆ°ä¸‹æ–¹ */
  @media (max-width: 900px){
    .layout{grid-template-columns: 1fr}
    aside{order:2}
  }
</style>
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 16 16%22><text y=%2214%22>ğŸ§—</text></svg>">
</head>
<body>
<header>
  <strong>ğŸ§—â€â™‚ï¸ Boulder Skeleton â€” Pro</strong>
  <span class="badge" id="diag">åˆå§‹åŒ–ä¸­â€¦</span>
  <div class="kpi">
    <span>FPS: <b id="fps">0</b></span>
    <span>Frames: <b id="frames">0</b></span>
    <span>é€²åº¦ï¼š<progress id="prog" max="1" value="0"></progress> <b id="tprog">0:00 / 0:00</b></span>
  </div>
</header>

<div class="layout">
  <!-- å·¦ï¼šä¸»ä½œæ¥­å€ï¼ˆæ§åˆ¶ + åª’é«”ï¼‰ -->
  <section>
    <div class="pane-head"><div>è¦–è¨Š / å½±ç‰‡</div><div></div></div>
    <div class="pane-body">
      <div class="row" style="margin-bottom:8px">
        <input id="file" type="file" accept="video/*" />
        <button id="cameraBtn">ä½¿ç”¨æ”åƒé ­</button>
        <button id="stopCameraBtn">é—œé–‰æ”åƒé ­</button>
        <select id="modelSel" title="BlazePose å‹è™Ÿ">
          <option value="lite">BlazePose Liteï¼ˆå¿«ï¼‰</option>
          <option value="full" selected>BlazePose Fullï¼ˆå‡è¡¡ï¼‰</option>
          <option value="heavy">BlazePose Heavyï¼ˆç²¾ç¢ºï¼‰</option>
        </select>
        <button id="startBtn">é–‹å§‹</button>
        <button id="pauseBtn">æš«åœ</button>
      </div>

      <div class="row" style="margin-bottom:8px">
        <label style="display:flex;align-items:center;gap:6px"><input id="recToggle" type="checkbox"> éŒ„è£½ Overlay</label>
        <button id="saveZipBtn" disabled>å­˜ ZIPï¼ˆå½±ç‰‡ + poses.json + metrics.csvï¼‰</button>
        <button id="aiBtn" title="ç”¨æœ¬æ©Ÿ Ollama ç”¢ç”Ÿå‹•ä½œè©•èª">ğŸ¤– AI Feedback</button>
      </div>

      <!-- åª’é«”å€ï¼šä¾å½±ç‰‡æ–¹å‘æ’ç‰ˆ -->
      <div class="media-grid" id="mediaGrid">
        <div class="origWrap">
          <video id="video" playsinline muted></video>
        </div>
        <div class="overlayWrap">
          <canvas id="canvas"></canvas>
        </div>
      </div>
    </div>
  </section>

  <!-- å³ï¼šå´æ¬„ï¼ˆæ›´å°ï¼‰ -->
  <aside>
    <div class="pane-head">
      <div>ç‹€æ…‹ / æ—¥èªŒ</div>
      <button id="selftestBtn">è‡ªæª¢</button>
    </div>
    <div class="pane-body">
      <div class="log" id="log">ç­‰å¾…è¼¸å‡ºâ€¦</div>
      <h4 style="margin:10px 0 6px;font-size:13px">ğŸ¤– AI å›é¥‹</h4>
      <div class="ai" id="aiOut">ï¼ˆæŒ‰ã€ŒAI Feedbackã€ï¼‰</div>
    </div>
  </aside>
</div>

<!-- ä¾è³´ï¼šTFJSï¼ˆä¾› envï¼‰ã€pose-detection 2.xã€Mediapipeã€JSZipï¼ˆå£“ç¸®ï¼‰ -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.20.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection@2.1.0/dist/pose-detection.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose"></script>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

<script>
(() => {
  const $ = id=>document.getElementById(id);
  const vid=$('video'), can=$('canvas'), ctx=can.getContext('2d');
  const file=$('file'), startBtn=$('startBtn'), pauseBtn=$('pauseBtn'),
        cameraBtn=$('cameraBtn'), stopCameraBtn=$('stopCameraBtn'), modelSel=$('modelSel');
  const log=$('log'), diag=$('diag'), selftestBtn=$('selftestBtn');
  const fpsEl=$('fps'), framesEl=$('frames'), prog=$('prog'), tprog=$('tprog');
  const recToggle=$('recToggle'), saveZipBtn=$('saveZipBtn'), aiBtn=$('aiBtn'), aiOut=$('aiOut');

  // â­ ä½ çš„æœ¬åœ°æ¨¡å‹ç›®éŒ„ï¼ˆéœ€è¦èˆ‡å¯¦éš›æ”¾ç½®ä¸€è‡´ï¼‰
    const USE_LOCAL_MODELS = false; // ç·šä¸Šæ¸¬è©¦æ™‚ä¿æŒ false
    const LOCAL_MODEL_DIR  = `${location.origin}/models/mp`;

    // æŒ‡å‘ä½ æ”¾åœ¨ GitHub çš„æ¨¡å‹ç›®éŒ„ï¼ˆjsDelivr CDNï¼‰ï¼š
    // æ³¨æ„ä¸è¦åŠ ä¸Šå…·é«”æª”å â€” createDetector æœƒå»æ‰¾é æœŸçš„æª”æ¡ˆåç¨±ï¼ˆå¦‚ pose_landmark_full.tfliteï¼‰
    const CDN_MODEL_DIR = 'https://cdn.jsdelivr.net/gh/thinskin-max/skeleton-models@main/models';

    const MODEL_DIR = USE_LOCAL_MODELS ? LOCAL_MODEL_DIR : CDN_MODEL_DIR;

  let detector=null, running=false, rafId=null;
  let frames=0, lastT=0, fpsHist=[];
  let frameStep=3, frameCount=0;

  const EDGES_BY_NAME = [
    ['left_shoulder','left_elbow'],['left_elbow','left_wrist'],
    ['right_shoulder','right_elbow'],['right_elbow','right_wrist'],
    ['left_hip','left_knee'],['left_knee','left_ankle'],
    ['right_hip','right_knee'],['right_knee','right_ankle'],
    ['left_shoulder','right_shoulder'],['left_hip','right_hip'],
    ['left_shoulder','left_hip'],['right_shoulder','right_hip']
  ];

  // Overlay éŒ„å½±
  let rec=null, recChunks=[];
  const poseLog=[];

  const say=(m,cls)=>{ const t=`[${new Date().toLocaleTimeString()}] ${m}\n`; log.textContent+=t; log.scrollTop=log.scrollHeight; diag.textContent=m; diag.className='badge '+(cls||''); };
  const pad=s=>String(s).padStart(2,'0');
  const fmtTime=sec=>`${Math.floor(sec/60)}:${pad(Math.floor(sec%60))}`;

  function fitCanvasToVideo(){
    if (!vid.videoWidth || !vid.videoHeight) return;
    can.width = vid.videoWidth;
    can.height = vid.videoHeight;

    // ä¾å½±ç‰‡æ–¹å‘åˆ‡æ›ç‰ˆé¢ï¼ˆportrait=å·¦å³ï¼›landscape=ä¸Šä¸‹ï¼‰
    if (vid.videoHeight > vid.videoWidth) {
      document.body.classList.add('portrait');
      document.body.classList.remove('landscape');
    } else {
      document.body.classList.add('landscape');
      document.body.classList.remove('portrait');
    }
  }

  function angle(a,b,c){ if(!a||!b||!c) return null;
    const ab=[a.x-b.x,a.y-b.y], cb=[c.x-b.x,c.y-b.y];
    const dot=ab[0]*cb[0]+ab[1]*cb[1], mab=Math.hypot(...ab), mcb=Math.hypot(...cb);
    if(mab*mcb===0) return null;
    return +(Math.acos(Math.min(1,Math.max(-1,dot/(mab*mcb))))*180/Math.PI).toFixed(1);
  }
  function tri(a,b,c){ if(!a||!b||!c) return null;
    return Math.abs((a.x*(b.y-c.y)+b.x*(c.y-a.y)+c.x*(a.y-b.y))/2);
  }

  function drawSkeleton(k){
    const byName = Object.fromEntries(k.map(kp=>[kp.name,kp]));
    for(const kp of k){ if(kp.score<0.5) continue;
      ctx.beginPath(); ctx.arc(kp.x,kp.y,3.5,0,Math.PI*2);
      ctx.fillStyle="#8bdcff"; ctx.fill();
    }
    ctx.lineWidth=2; ctx.strokeStyle="#61a0ff";
    for(const [a,b] of EDGES_BY_NAME){
      const p=byName[a], q=byName[b];
      if(p?.score>0.5 && q?.score>0.5){
        ctx.beginPath(); ctx.moveTo(p.x,p.y); ctx.lineTo(q.x,q.y); ctx.stroke();
      }
    }
  }

  function summarize(byName){
    const la = angle(byName['left_shoulder'],byName['left_elbow'],byName['left_wrist']);
    const ra = angle(byName['right_shoulder'],byName['right_elbow'],byName['right_wrist']);
    const lk = angle(byName['left_hip'],byName['left_knee'],byName['left_ankle']);
    const rk = angle(byName['right_hip'],byName['right_knee'],byName['right_ankle']);
    const baseL = tri(byName['left_shoulder'],byName['left_hip'],byName['left_ankle']);
    const baseR = tri(byName['right_shoulder'],byName['right_hip'],byName['right_ankle']);
    return {elbowL:la, elbowR:ra, kneeL:lk, kneeR:rk, baseL, baseR};
  }

  async function loadDetector(){
    const type = modelSel.value;
    detector = await poseDetection.createDetector(
      poseDetection.SupportedModels.BlazePose,
      { runtime:'mediapipe', solutionPath: MODEL_DIR, modelType:type, enableSmoothing:true }
    );
    say(`BlazePose è¼‰å…¥æˆåŠŸï¼ˆ${type}ï¼Œæœ¬åœ°ï¼‰ âœ…`,'ok');
  }

  function updateProgressUI(){
    if (isFinite(vid.duration) && vid.duration>0){
      prog.max=1; prog.value=Math.min(1, vid.currentTime/vid.duration);
      tprog.textContent=`${fmtTime(vid.currentTime)} / ${fmtTime(vid.duration)}`;
    } else { prog.value=0; tprog.textContent='0:00 / 0:00'; }
  }

  function pickMime() {
  const cand = [
    'video/webm;codecs=vp9',
    'video/webm;codecs=vp8',
    'video/mp4;codecs=h264'      // iOS Safari å¸¸è¦‹åƒ…æ­¤å¯éŒ„
  ];
  for (const t of cand) {
    if (window.MediaRecorder && MediaRecorder.isTypeSupported(t)) return t;
  }
  return ''; // ä¸æ”¯æ´éŒ„å½±
}

function startRecordingIfNeeded(){
  if (!recToggle.checked || rec) return;

  const mime = pickMime();
  if (!mime) { 
    say('âš ï¸ æ­¤ç€è¦½å™¨ä¸æ”¯æ´ MediaRecorder éŒ„å½±','warn');
    recToggle.checked = false;
    saveZipBtn.disabled = true;
    return;
  }

  const stream = can.captureStream( (mime.includes('mp4') ? 30 : 60) ); // Safari ä¸Š MP4 é€šå¸¸ 30fps è¼ƒç©©
  recChunks = [];
  try {
    rec = new MediaRecorder(stream, { mimeType: mime });
  } catch (e) {
    say('Recorder åˆå§‹åŒ–å¤±æ•—ï¼š' + e.message, 'err');
    recToggle.checked = false;
    return;
  }
  rec.ondataavailable = e => { if (e.data?.size) recChunks.push(e.data); };
  rec.onstop = () => console.log(`[ğŸ¥] éŒ„å½±å®Œæˆ, mime=${mime}, size=${recChunks.reduce((s,b)=>s+b.size,0)} bytes`);
  rec.start();
  saveZipBtn.disabled = false;
  say(`ğŸ¥ Overlay éŒ„å½±é–‹å§‹ï¼ˆ${mime}ï¼‰`,'ok');
}


  async function loop(t){
    if (!running) return;
    frameCount++; if (frameCount%frameStep!==0) return rafId=requestAnimationFrame(loop);

    if (vid.readyState>=2){
      try{
        const poses = await detector.estimatePoses(vid);
        ctx.drawImage(vid,0,0,can.width,can.height);
        const k = poses[0]?.keypoints || [];
        if (k.length){
          drawSkeleton(k);
          const byName = Object.fromEntries(k.map(kp=>[kp.name,kp]));
          const metrics = summarize(byName);
          poseLog.push({ t:+vid.currentTime.toFixed(3), keypoints:k.map(({name,x,y,score})=>({name,x,y,score})), angles:metrics });
        }
        // KPI
        frames++; framesEl.textContent=frames;
        if (lastT){ const inst=1000/(t-lastT); fpsHist.push(inst); if(fpsHist.length>30) fpsHist.shift(); }
        lastT=t; const avg=fpsHist.length?Math.round(fpsHist.reduce((a,b)=>a+b,0)/fpsHist.length):0; $('fps').textContent=avg;
        updateProgressUI(); startRecordingIfNeeded();
      }catch(e){ say('ä¼°è¨ˆå¤±æ•—ï¼š'+e.message,'err'); running=false; return; }
    }
    rafId=requestAnimationFrame(loop);
  }

  // === äº‹ä»¶ ===
  file.onchange=()=>{ const f=file.files[0]; if(!f) return;
    vid.src=URL.createObjectURL(f);
    vid.onloadedmetadata=()=>{ fitCanvasToVideo(); vid.play().catch(()=>{}); say('ğŸï¸ å½±ç‰‡å°±ç·’ï¼ŒæŒ‰ã€Œé–‹å§‹ã€','ok'); updateProgressUI(); };
    vid.ontimeupdate=updateProgressUI;
  };
  cameraBtn.onclick=async()=>{ try{
      const s=await navigator.mediaDevices.getUserMedia({video:true,audio:false});
      vid.srcObject=s; vid.onloadedmetadata=()=>{ fitCanvasToVideo(); vid.play(); say('ğŸ“· æ”åƒé ­å°±ç·’ï¼ŒæŒ‰ã€Œé–‹å§‹ã€','ok'); updateProgressUI(); };
      vid.ontimeupdate=updateProgressUI;
    }catch(e){ say('ç›¸æ©Ÿä¸å¯ç”¨ï¼š'+e.message,'err'); }
  };
  stopCameraBtn.onclick=()=>{ if(vid.srcObject){ vid.srcObject.getTracks().forEach(t=>t.stop()); vid.srcObject=null; say('ğŸ“´ æ”åƒé ­å·²é—œé–‰','warn'); } else { say('âš ï¸ æ²’æœ‰æ”åƒé ­æ­£åœ¨é‹è¡Œ','warn'); } };

  startBtn.onclick=async()=>{ 
    if(!vid.src && !vid.srcObject){ alert('å…ˆè¼‰å…¥å½±ç‰‡æˆ–é–‹ç›¸æ©Ÿ'); return; }
    try{
      if(!detector){ say('è¼‰å…¥æœ¬åœ°æ¨¡å‹ä¸­â€¦','warn'); await loadDetector(); }
      poseLog.length=0; frames=0; fpsHist.length=0; lastT=0;
      running=true; if(vid.paused) await vid.play().catch(()=>{});
      if(!rafId) rafId=requestAnimationFrame(loop);
      say('â–¶ï¸ é–‹å§‹','ok');
    }catch(e){ say('âŒ æ¨¡å‹è¼‰å…¥å¤±æ•—ï¼š'+e.message,'err'); }
  };
  pauseBtn.onclick=()=>{ running=false; if(rafId){ cancelAnimationFrame(rafId); rafId=null; } say('â¸ æš«åœ','warn'); };

  selftestBtn.onclick=async()=>{ log.textContent=''; say('è‡ªæª¢ä¸­â€¦','warn');
    if(typeof poseDetection==='undefined'){ say('âŒ æ‰¾ä¸åˆ° pose-detection','err'); return; }
    try{ await loadDetector(); say('âœ… è‡ªæª¢å®Œæˆï¼šæœ¬åœ°æ¨¡å‹è¼‰å…¥æˆåŠŸï¼Œå¯è¼‰å…¥å½±ç‰‡/ç›¸æ©Ÿå†æŒ‰ã€Œé–‹å§‹ã€','ok'); }
    catch(e){ say('âŒ è¼‰å…¥å¤±æ•—ï¼š'+e.message,'err'); }
  };

  // ä¸‹è¼‰ ZIP
  $('saveZipBtn').onclick=async()=>{ try{
      const zip=new JSZip();
      const vblob=await stopRecordingBlob(); if(vblob) zip.file('overlay.webm', vblob);
      zip.file('poses.json', JSON.stringify({meta:{createdAt:new Date().toISOString(),model:'BlazePose/mediapipe',modelType:modelSel.value,width:can.width,height:can.height,frameStep},frames:poseLog},null,2));
      const csvHeader='t,elbowL,elbowR,kneeL,kneeR,baseL,baseR\n';
      const csvBody=poseLog.map(r=>{const a=r.angles||{};return [r.t,a.elbowL??'',a.elbowR??'',a.kneeL??'',a.kneeR??'',a.baseL??'',a.baseR??''].join(',');}).join('\n');
      zip.file('metrics.csv', csvHeader+csvBody);
      const blob=await zip.generateAsync({type:'blob'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`boulder_skeleton_${Date.now()}.zip`; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),1500);
      say('ğŸ“¦ ZIP å·²ä¸‹è¼‰','ok');
    }catch(e){ say('ZIP å¤±æ•—ï¼š'+e.message,'err'); }
  };

  // ğŸ¤– Ollama
  $('aiBtn').onclick=async()=>{ try{
      if(!poseLog.length){ $('aiOut').textContent='è«‹å…ˆé–‹å§‹åˆ†æï¼Œç”¢ç”Ÿä¸€äº›å¹€è³‡æ–™ã€‚'; return; }
      const T=poseLog[poseLog.length-1].t; const recent=poseLog.filter(r=>T-r.t<=5);
      const avg=(arr,key)=>{const v=arr.map(x=>x?.angles?.[key]).filter(Number.isFinite);return v.length?+(v.reduce((a,b)=>a+b,0)/v.length).toFixed(1):null;};
      const summary={windowSec:Math.min(5,Math.round(T)),elbowL:avg(recent,'elbowL'),elbowR:avg(recent,'elbowR'),kneeL:avg(recent,'kneeL'),kneeR:avg(recent,'kneeR'),baseL:avg(recent,'baseL'),baseR:avg(recent,'baseR')};
      const prompt=`You are a climbing movement coach.
Given average joint metrics over last ${summary.windowSec}s:
- Elbow(L/R): ${summary.elbowL}/${summary.elbowR} deg
- Knee(L/R): ${summary.kneeL}/${summary.kneeR} deg
- Base area(L/R): ${summary.baseL}/${summary.baseR}
Provide 3 terse, practical coaching cues to improve body position for lead climbing. Use bullet points.`;
      $('aiOut').textContent='å‘¼å« Ollama ä¸­â€¦';
      const resp=await fetch('http://localhost:11434/api/generate',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({model:'mistral',prompt,stream:false})}).then(r=>r.ok?r.json():Promise.reject(new Error(r.status+' '+r.statusText)));
      $('aiOut').textContent=(resp?.response||'').trim()||'ï¼ˆOllama æ²’æœ‰å›å‚³å…§å®¹ï¼‰';
      say('ğŸ¤– AI å›é¥‹å®Œæˆ','ok');
    }catch(e){
      $('aiOut').textContent='ç„¡æ³•é€£åˆ° Ollamaã€‚è«‹åœ¨æœ¬æ©ŸåŸ·è¡Œä¸¦è¨­å®š CORSï¼ˆOLLAMA_ORIGINS=*ï¼‰ã€‚\néŒ¯èª¤ï¼š'+e.message;
      say('AI å¤±æ•—ï¼š'+e.message,'err');
    }
  };

  // åˆå§‹åŒ–ï¼šè¼•è§¸è‡ªæª¢
  setTimeout(()=>selftestBtn.click(),200);
})();
</script>
</body>
</html>
